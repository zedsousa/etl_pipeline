services:
  source_db:
    image: postgres:15
    container_name: source_db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: source_db
    ports:
      - "5432:5432"
    volumes:
      - source_db_data:/var/lib/postgresql/data

  target_db:
    image: postgres:15
    container_name: target_db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: target_db
    ports:
      - "5433:5432"
    volumes:
      - target_db_data:/var/lib/postgresql/data

  api:
    build: .
    container_name: api
    command: uvicorn api.main:app --host 0.0.0.0 --port 8000
    ports:
      - "8000:8000"
    depends_on:
      - source_db
    environment:
      SOURCE_DB_URL: postgresql://postgres:postgres@source_db:5432/source_db

  dagster_webserver:
    build: .
    container_name: dagster_webserver
    command: dagster-webserver -h 0.0.0.0 -p 3000 -w workspace.yaml
    ports:
      - "3000:3000"
    depends_on:
      - target_db
      - api
    environment:
      API_URL: http://api:8000
      TARGET_DB_URL: postgresql://postgres:postgres@target_db:5432/target_db
      DAGSTER_HOME: /opt/dagster/dagster_home
    volumes:
      - ./dagster_home:/opt/dagster/dagster_home
      - .:/app

  dagster_daemon:
    build: .
    container_name: dagster_daemon
    command: dagster-daemon run
    depends_on:
      - target_db
      - api
    environment:
      API_URL: http://api:8000
      TARGET_DB_URL: postgresql://postgres:postgres@target_db:5432/target_db
      DAGSTER_HOME: /opt/dagster/dagster_home
    volumes:
      - ./dagster_home:/opt/dagster/dagster_home
      - .:/app

volumes:
  source_db_data:
  target_db_data: